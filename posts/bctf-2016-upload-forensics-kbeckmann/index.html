<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=author content="xil.se"><link rel=prev href=https://blog.xil.se/posts/bkp-2016-jit-re-kbeckmann/><link rel=next href=https://blog.xil.se/posts/pwn2win-2016-spiral-kbeckmann/><link rel=canonical href=https://blog.xil.se/posts/bctf-2016-upload-forensics-kbeckmann/><link rel=apple-touch-icon sizes=180x180 href=https://blog.xil.se/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://blog.xil.se/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://blog.xil.se/favicon-16x16.png><link rel=manifest href=https://blog.xil.se/site.webmanifest><link rel=mask-icon href=https://blog.xil.se/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title>BCTF 2016 Upload (Forensics 200) Writeup | Blog</title><meta name=title content="BCTF 2016 Upload (Forensics 200) Writeup | Blog"><link rel=stylesheet href=https://blog.xil.se/font/iconfont.css><link rel=stylesheet href=https://blog.xil.se/css/main.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.xil.se\/"},"articleSection":"posts","name":"BCTF 2016 Upload (Forensics 200) Writeup","headline":"BCTF 2016 Upload (Forensics 200) Writeup","description":"Problem  Where are the files I just uploaded?\nThe files in the links below are the same, download any of them to begin hacking!\ndisk.img.xz - google drive link\ndisk.img.xz - dropbox link\ndisk.img.xz - baidu link\n Solution We get a packed binary blob. Unpack it using xz and use file to see what it is.\n$ xz -d disk.img.xz $ file disk.img disk.img: BTRFS Filesystem sectorsize 4096, nodesize 16384, leafsize 16384, UUID=89011762- aee-4847-9e0f-bca52fd99e0d, 155820032\/2147483648 bytes used, 1 devices  Oh a BTRFS image.","inLanguage":"en-us","author":"kbeckmann","creator":"kbeckmann","publisher":"kbeckmann","accountablePerson":"kbeckmann","copyrightHolder":"kbeckmann","copyrightYear":"2016","datePublished":"2016-03-21 06:41:21 \u002b0100 \u002b0100","dateModified":"2016-03-21 06:41:21 \u002b0100 \u002b0100","url":"https:\/\/blog.xil.se\/posts\/bctf-2016-upload-forensics-kbeckmann\/","wordCount":"425","keywords":["Blog"]}</script></head><body><div class=wrapper><nav class=navbar><div class=container><div class="navbar-header header-logo"><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href=https://blog.xil.se/>Blog</a></div><div class="menu navbar-right"><a class=menu-item href=https://blog.xil.se/posts/>Blog</a>
<a class=menu-item href=https://blog.xil.se/categories/>Categories</a></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><div class=container><div class=navbar-header><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href=https://blog.xil.se/>Blog</a></div><div class=menu-toggle><span></span><span></span><span></span></div></div><div class=menu id=mobile-menu><a class=menu-item href=https://blog.xil.se/posts/>Blog</a>
<a class=menu-item href=https://blog.xil.se/categories/>Categories</a></div></div></nav><main class=main><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline">BCTF 2016 Upload (Forensics 200) Writeup</h1><div class=post-meta>Written by <a itemprop=name href=https://blog.xil.se/author/kbeckmann rel=author>kbeckmann</a> with ♥
<span class=post-time>on <time datetime=2016-03-21 itemprop=datePublished>March 21, 2016</time></span>
in
<i class="iconfont icon-folder"></i><span class=post-category><a href=https://blog.xil.se/categories/writeups/>writeups</a></span></div></header><div class=post-content><h1 id=problem>Problem</h1><blockquote><p>Where are the files I just uploaded?</p><p>The files in the links below are the same, download any of them to begin hacking!</p><p>disk.img.xz - google drive link</p><p>disk.img.xz - dropbox link</p><p>disk.img.xz - baidu link</p></blockquote><h1 id=solution>Solution</h1><p>We get a packed binary blob. Unpack it using <code>xz</code> and use <code>file</code> to see what it is.</p><pre><code>$ xz -d disk.img.xz

$ file disk.img
disk.img: BTRFS Filesystem sectorsize 4096, nodesize 16384, leafsize 16384, UUID=89011762- aee-4847-9e0f-bca52fd99e0d, 155820032/2147483648 bytes used, 1 devices
</code></pre><p>Oh a BTRFS image. Nice.</p><p>Since this is a forensics challenge I didn&rsquo;t even bother mounting it, it probably has some hidden partition or something.</p><p>Let&rsquo;s use <code>btrfs restore</code>:</p><pre><code>$ mkdir restore
$ btrfs restore disk.img restore
Skipping snapshot dc34ada559d579c63d7c50c8348a854e9d9873850987e8d08b6493a2d1921b0a
Skipping snapshot 9e7eba4abf699021c04b4a4ce42972c297b47b7ef2b41bdbbc4f08955c21c3e1
Skipping snapshot b111de287cf2b2daa8392b0d4c7f76a84a5e7cd3687bdd118960f44d8410e9ca
Skipping snapshot ed268c5e6895b2cfa9518b6b2df98a0972207b3e569d758dc07d7e539478962c
Skipping snapshot 3b0bf85b8b3403bcc72f6ad2fdfdc5685e4aa8290b996c54f76435ef14ae19f5
Skipping snapshot 15286535e2415659c01c4e5d28e7b7572bd7c7e1d73b2931880b5e0b291b730b
</code></pre><p>Ok looks interesting. But these snapshots sound interesting, let&rsquo;s dump them!</p><pre><code>$ mkdir restore2
$ btrfs restore -si disk.img restore2
</code></pre><p>This takes a while. Now we have the snapshots:</p><pre><code>$ ls restore2/btrfs/subvolumes/
15286535e2415659c01c4e5d28e7b7572bd7c7e1d73b2931880b5e0b291b730b/
3b0bf85b8b3403bcc72f6ad2fdfdc5685e4aa8290b996c54f76435ef14ae19f5/
3b8877cfaaff2e44fbe24b43c3ea2e2d92b05831c5ce01b8a4928f6ced5d2c42/
9e7eba4abf699021c04b4a4ce42972c297b47b7ef2b41bdbbc4f08955c21c3e1/
b111de287cf2b2daa8392b0d4c7f76a84a5e7cd3687bdd118960f44d8410e9ca/
dc34ada559d579c63d7c50c8348a854e9d9873850987e8d08b6493a2d1921b0a/
ed268c5e6895b2cfa9518b6b2df98a0972207b3e569d758dc07d7e539478962c/
</code></pre><p>Let&rsquo;s diff them and see where files are added and removed. I used find and diff, ended up finding these files:</p><pre><code>&gt; ./data
&gt; ./SimpleHTTPServerWithUpload.py
</code></pre><p><code>SimpleHTTPServerWithUpload.py</code> looks really interesting. Turns out it&rsquo;s some kind of file upload server, and the code contains a URL &ldquo;<a href=http://li2z.cn/%22,>http://li2z.cn/",</a> so I thought I was supposed to hack that site. Anyway, this was not the case.</p><p>After searching for more interesting files and almost giving up, I found another btrfs command.</p><pre><code>$ btrfs restore -l disk.img
tree key (EXTENT_TREE ROOT_ITEM 0) 54853632 level 1
tree key (DEV_TREE ROOT_ITEM 0) 65847296 level 0
tree key (FS_TREE ROOT_ITEM 0) 54804480 level 1
tree key (CSUM_TREE ROOT_ITEM 0) 54935552 level 1
tree key (UUID_TREE ROOT_ITEM 0) 30048256 level 0
tree key (257 ROOT_ITEM 0) 39223296 level 2
tree key (259 ROOT_ITEM 8) 46202880 level 2
tree key (260 ROOT_ITEM 9) 47054848 level 2
tree key (261 ROOT_ITEM 10) 62816256 level 2
tree key (264 ROOT_ITEM 13) 95059968 level 2
tree key (267 ROOT_ITEM 17) 115474432 level 2
tree key (270 ROOT_ITEM 20) 76054528 level 2
tree key (277 ROOT_ITEM 27) 53788672 level 2
tree key (278 ROOT_ITEM 28) 80281600 level 2
tree key (DATA_RELOC_TREE ROOT_ITEM 0) 29442048 level 0
</code></pre><p>Oh look, more information.</p><p>It is possible to extract the trees using <code>btrfs restore -r &lt;id></code>:</p><pre><code>$ btrfs restore -r 278 disk.img restore3
</code></pre><p>And now, let&rsquo;s see what we have.</p><pre><code>$ ls restore3/data
cat.jpg  fLaG  flags-clip-art-red-flag.pdf  not_flag.txt
$ ./restore3/data/fLaG
BCTF{it_s_no7_hard_to_r0cov3r_is_n_t_17}
</code></pre><p>And there it was, some fake flags and the actual flag.</p></div><div class=post-copyright><p class=copyright-item><span>Author:</span>
<span>xil.se</span></p><p class=copyright-item><span>Link:</span>
<a href=https://blog.xil.se/posts/bctf-2016-upload-forensics-kbeckmann/>https://blog.xil.se/posts/bctf-2016-upload-forensics-kbeckmann/</span></p></div><div class=post-tags><section><a href=javascript:window.history.back();>back</a></span> ·
<span><a href=https://blog.xil.se/>home</a></span></section></div><div class=post-nav><a href=https://blog.xil.se/posts/bkp-2016-jit-re-kbeckmann/ class=prev rel=prev title="Boston Key Party 2016 Jit in my pants (RE 3) Writeup"><i class="iconfont icon-left"></i>&nbsp;Boston Key Party 2016 Jit in my pants (RE 3) Writeup</a>
<a href=https://blog.xil.se/posts/pwn2win-2016-spiral-kbeckmann/ class=next rel=next title="Pwn2Win 2016 Square Infinite Spiral Writeup">Pwn2Win 2016 Square Infinite Spiral Writeup&nbsp;<i class="iconfont icon-right"></i></a></div><div class=post-comment></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span class=with-love><i class="iconfont icon-love"></i></span><span class=author itemprop=copyrightHolder><a href=https://blog.xil.se/>xil.se</a> |</span>
<span>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow">Hugo</a> & <a href=https://github.com/liuzc/leaveit target=_blank rel="external nofollow">LeaveIt</a></span></div></footer><script src=https://blog.xil.se/js/vendor_no_gallery.min.js async></script></div></body></html>